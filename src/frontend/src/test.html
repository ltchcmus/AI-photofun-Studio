<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Feature API Tester</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .loader { border-top-color: #3498db; animation: spinner 1.5s linear infinite; }
        @keyframes spinner { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-gray-100 min-h-screen p-8">
    <div class="max-w-4xl mx-auto">
        <h1 class="text-3xl font-bold text-center mb-8 text-blue-600">AI Features API Tester</h1>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            
            <div class="bg-white p-6 rounded-lg shadow-md">
                <h2 class="text-xl font-semibold mb-4 border-b pb-2">1. Image Generation</h2>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium">Prompt</label>
                        <input id="gen-prompt" type="text" value="A beautiful sunset over mountains, photorealistic" class="w-full border p-2 rounded mt-1">
                    </div>
                    <div class="grid grid-cols-2 gap-2">
                        <div>
                            <label class="block text-sm font-medium">Model</label>
                            <select id="gen-model" class="w-full border p-2 rounded mt-1">
                                <option value="realism">Realism</option>
                                <option value="artistic">Artistic</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium">Aspect Ratio</label>
                            <input id="gen-ratio" type="text" value="16:9" class="w-full border p-2 rounded mt-1">
                        </div>
                    </div>
                    <button onclick="generateImage()" id="btn-gen" class="w-full bg-blue-500 text-white py-2 rounded hover:bg-blue-600 transition">Generate</button>
                </div>
                <div id="gen-result" class="mt-4 hidden">
                    <p class="text-sm font-bold">Status: <span id="gen-status">Waiting...</span></p>
                    <div id="gen-loader" class="loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-8 w-8 mx-auto my-2 hidden"></div>
                    <img id="gen-img" src="" class="mt-2 w-full rounded shadow hidden">
                </div>
            </div>

            <div class="bg-white p-6 rounded-lg shadow-md">
                <h2 class="text-xl font-semibold mb-4 border-b pb-2">2. Remove Background</h2>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium">Image URL</label>
                        <input id="bg-url" type="text" value="https://images.unsplash.com/photo-1506748686214-e9df14d4d9d0?w=800" class="w-full border p-2 rounded mt-1">
                    </div>
                    <button onclick="removeBackground()" id="btn-bg" class="w-full bg-purple-500 text-white py-2 rounded hover:bg-purple-600 transition">Remove Background</button>
                </div>
                <div id="bg-result" class="mt-4 hidden">
                    <p class="text-sm font-bold text-green-600">Result:</p>
                    <img id="bg-img-res" src="" class="mt-2 w-full rounded shadow">
                </div>
            </div>

        </div>

        <div class="mt-8 bg-gray-800 text-green-400 p-4 rounded-lg font-mono text-sm overflow-x-auto">
            <h3 class="text-white mb-2 border-b border-gray-600">Console Logs:</h3>
            <div id="logs" class="h-40 overflow-y-auto"></div>
        </div>
    </div>

    <script>
        const BASE_URL = "http://localhost:9999";
        const SESSION_ID = "web_test_" + Date.now();

        function log(message) {
            const logDiv = document.getElementById('logs');
            logDiv.innerHTML += `<div>> ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        async function pollTask(taskId, endpoint, imgElementId, statusId, loaderId) {
            const maxAttempts = 30;
            const statusText = document.getElementById(statusId);
            const loader = document.getElementById(loaderId);
            const imgTarget = document.getElementById(imgElementId);

            for (let i = 1; i <= maxAttempts; i++) {
                log(`Polling task ${taskId} (Attempt ${i})...`);
                try {
                    const response = await fetch(`${BASE_URL}/${endpoint}/status/${taskId}/?user_id=${SESSION_ID}`);
                    const data = await response.json();
                    const status = data.result.status;
                    
                    statusText.innerText = status;

                    if (status === "COMPLETED") {
                        log("Success: Task completed!");
                        imgTarget.src = data.result.image_url || data.result.output_url;
                        imgTarget.classList.remove('hidden');
                        loader.classList.add('hidden');
                        return;
                    }

                    if (status === "FAILED") {
                        log("Error: Task failed!");
                        loader.classList.add('hidden');
                        return;
                    }
                } catch (err) {
                    log("Polling error: " + err.message);
                }
                await new Promise(r => setTimeout(r, 3000));
            }
            log("Timeout waiting for task.");
        }

        async function generateImage() {
            const prompt = document.getElementById('gen-prompt').value;
            const model = document.getElementById('gen-model').value;
            const ratio = document.getElementById('gen-ratio').value;
            
            document.getElementById('gen-result').classList.remove('hidden');
            document.getElementById('gen-loader').classList.remove('hidden');
            document.getElementById('gen-img').classList.add('hidden');
            log("Starting Image Generation...");

            try {
                const res = await fetch(`${BASE_URL}/v1/features/image-generation/`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        user_id: SESSION_ID,
                        prompt: prompt,
                        model: model,
                        aspect_ratio: ratio,
                        session_id: SESSION_ID
                    })
                });
                const data = await res.json();
                const taskId = data.result.task_id;
                
                if (taskId) {
                    log("Task ID received: " + taskId);
                    pollTask(taskId, "v1/features/image-generation", "gen-img", "gen-status", "gen-loader");
                }
            } catch (err) {
                log("Fetch Error: " + err.message);
            }
        }

        async function removeBackground() {
            const imageUrl = document.getElementById('bg-url').value;
            log("Starting Remove Background...");
            
            try {
                const res = await fetch(`${BASE_URL}/v1/features/remove-background/`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        user_id: SESSION_ID,
                        image_url: imageUrl,
                        session_id: SESSION_ID
                    })
                });
                const data = await res.json();
                
                if (data.result && data.result.image_url) {
                    log("Background removed successfully");
                    document.getElementById('bg-result').classList.remove('hidden');
                    document.getElementById('bg-img-res').src = data.result.image_url;
                } else {
                    log("Failed to remove background");
                }
            } catch (err) {
                log("Fetch Error: " + err.message);
            }
        }
    </script>
</body>
</html>