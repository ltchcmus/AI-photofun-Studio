name: "deploy"
on:
  push:
    branches: ["test"]
    tags:
      - "v*"
    paths:
      - "src/**"
      - "Dockerfile"
      - "docker-compose.yml"
      - ".github/workflows/deploy.yaml"
  pull_request:
    branches: ["master"]
    paths:
      - "src/**"
      - "Dockerfile"
      - "docker-compose.yml"
      - ".github/workflows/deploy.yaml"
  workflow_dispatch:

jobs:
  deploy:
    name: "Deploy Application"
    runs-on: ubuntu-latest
    steps:
      - name: "SSH"
        env:
          DEPLOY_PATH: "/var/www/html/nmcnpm.lethanhcong.site/"
          BRANCH: "test"

          # Repository Variables
          CORS_ORIGINS: ${{ vars.CORS_ORIGINS }}
          DEBUG: ${{ vars.DEBUG }}
          GPU_DEVICE_ID: ${{ vars.GPU_DEVICE_ID }}
          MONGO_DB_NAME: ${{ vars.MONGO_DB_NAME }}
          MONGO_URI: ${{ vars.MONGO_URI }}
          SECRET_KEY: ${{ vars.SECRET_KEY }}
          TIME_ZONE: ${{ vars.TIME_ZONE }}
          USE_GPU: ${{ vars.USE_GPU }}
          USE_TZ: ${{ vars.USE_TZ }}
          VITE_GOOGLE_CLIENT_ID: ${{ vars.VITE_GOOGLE_CLIENT_ID }}
          VITE_GOOGLE_REDIRECT_URI: ${{ vars.VITE_GOOGLE_REDIRECT_URI }}
          VITE_SOCIAL_GATWAY_API_URL: ${{ vars.VITE_SOCIAL_GATWAY_API_URL }}
          VITE_TURN_CREDENTIAL_1: ${{ vars.VITE_TURN_CREDENTIAL_1 }}
          VITE_TURN_CREDENTIAL_2: ${{ vars.VITE_TURN_CREDENTIAL_2 }}
          VITE_TURN_URL_1: ${{ vars.VITE_TURN_URL_1 }}
          VITE_TURN_URL_2: ${{ vars.VITE_TURN_URL_2 }}
          VITE_TURN_USERNAME_1: ${{ vars.VITE_TURN_USERNAME_1 }}
          VITE_TURN_USERNAME_2: ${{ vars.VITE_TURN_USERNAME_2 }}
          VITE_API_GATEWAY: ${{ vars.VITE_API_GATEWAY }}
          VITE_AI_API_URL: ${{ vars.VITE_AI_API_URL }}
          VITE_SOCKET_URL: ${{ vars.VITE_SOCKET_URL }}
          VITE_SOCKET_COMMENT_URL: ${{ vars.VITE_SOCKET_COMMENT_URL }}
          VITE_COMMENT_API_URL: ${{ vars.VITE_COMMENT_API_URL }}
          VITE_PAYMENT_API_URL: ${{ vars.VITE_PAYMENT_API_URL }}
          VITE_FILE_UPLOAD_URL: ${{ vars.VITE_FILE_UPLOAD_URL }}
          VITE_CHATBOT_API_URL: ${{ vars.VITE_CHATBOT_API_URL }}
          MODELSTUDIO_API_BASE: ${{ vars.MODELSTUDIO_API_BASE }}
          FREEPIK_API_KEY: ${{ vars.FREEPIK_API_KEY }}

          # Repository Secrets
          GEMINI_API_KEYS: ${{ secrets.GEMINI_API_KEYS }}
          GOOGLE_CLIENT_SECRET: ${{ secrets.GOOGLE_CLIENT_SECRET }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          SUPABASE_DB_HOST: ${{ secrets.SUPABASE_DB_HOST }}
          SUPABASE_DB_NAME: ${{ secrets.SUPABASE_DB_NAME }}
          SUPABASE_DB_PASSWORD: ${{ secrets.SUPABASE_DB_PASSWORD }}
          SUPABASE_DB_PORT: ${{ secrets.SUPABASE_DB_PORT }}
          SUPABASE_DB_SSLMODE: ${{ secrets.SUPABASE_DB_SSLMODE }}
          SUPABASE_DB_USER: ${{ secrets.SUPABASE_DB_USER }}
          VITE_FIREBASE_API_KEY: ${{ secrets.VITE_FIREBASE_API_KEY }}
          VITE_FIREBASE_APP_ID: ${{ secrets.VITE_FIREBASE_APP_ID }}
          VITE_FIREBASE_AUTH_DOMAIN: ${{ secrets.VITE_FIREBASE_AUTH_DOMAIN }}
          VITE_FIREBASE_MEASUREMENT_ID: ${{ secrets.VITE_FIREBASE_MEASUREMENT_ID }}
          VITE_FIREBASE_MESSAGING_SENDER_ID: ${{ secrets.VITE_FIREBASE_MESSAGING_SENDER_ID }}
          VITE_FIREBASE_PROJECT_ID: ${{ secrets.VITE_FIREBASE_PROJECT_ID }}
          VITE_FIREBASE_STORAGE_BUCKET: ${{ secrets.VITE_FIREBASE_STORAGE_BUCKET }}
          MODELSTUDIO_API_KEY: ${{ secrets.MODELSTUDIO_API_KEY }}
          VITE_PAYMENT_API_KEY: ${{ secrets.VITE_PAYMENT_API_KEY }}
          VITE_CHATBOT_BEARER_TOKEN: ${{ secrets.VITE_CHATBOT_BEARER_TOKEN }}
          VITE_CHATBOT_USER_ID: ${{ secrets.VITE_CHATBOT_USER_ID }}
          VITE_CHATBOT_X_API_KEY: ${{ secrets.VITE_CHATBOT_X_API_KEY }}

        uses: appleboy/ssh-action@v0.1.6
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE }}
          port: ${{ secrets.SSH_PORT }}
          command_timeout: 50m
          envs: DEPLOY_PATH,BRANCH,DEBUG,MONGO_DB_NAME,MONGO_URI,SECRET_KEY,GEMINI_API_KEYS,GOOGLE_CLIENT_SECRET,OPENAI_API_KEY,FREEPIK_API_KEY,SUPABASE_DB_HOST,SUPABASE_DB_NAME,SUPABASE_DB_PASSWORD,SUPABASE_DB_PORT,SUPABASE_DB_SSLMODE,SUPABASE_DB_USER,VITE_GOOGLE_CLIENT_ID,VITE_GOOGLE_REDIRECT_URI,VITE_SOCIAL_GATWAY_API_URL,VITE_TURN_CREDENTIAL_1,VITE_TURN_CREDENTIAL_2,VITE_TURN_URL_1,VITE_TURN_URL_2,VITE_TURN_USERNAME_1,VITE_TURN_USERNAME_2,VITE_API_GATEWAY,VITE_AI_API_URL,VITE_FILE_UPLOAD_URL,VITE_SOCKET_URL,VITE_SOCKET_COMMENT_URL,VITE_COMMENT_API_URL,VITE_PAYMENT_API_URL,VITE_CHATBOT_API_URL,MODELSTUDIO_API_BASE,VITE_FIREBASE_API_KEY,VITE_FIREBASE_APP_ID,VITE_FIREBASE_AUTH_DOMAIN,VITE_FIREBASE_MEASUREMENT_ID,VITE_FIREBASE_MESSAGING_SENDER_ID,VITE_FIREBASE_PROJECT_ID,VITE_FIREBASE_STORAGE_BUCKET,MODELSTUDIO_API_KEY,VITE_PAYMENT_API_KEY,VITE_CHATBOT_BEARER_TOKEN,VITE_CHATBOT_USER_ID,VITE_CHATBOT_X_API_KEY
          script: |
            WORKSPACE="/home/$USER/AI-photofun-Studio"
            if [ -d "$WORKSPACE" ]; then
              cd $WORKSPACE
              git fetch origin
              git reset --hard origin/$BRANCH
              git clean -fd
            else
              cd /home/$USER
              git clone https://github.com/Dev-Web-2005/AI-photofun-Studio.git
              cd AI-photofun-Studio
              git checkout $BRANCH
            fi

            echo "Deploying backendSocial..."
            cd $WORKSPACE/src/backend/backendSocial
            export GOOGLE_CLIENT_SECRET=$GOOGLE_CLIENT_SECRET
            export CORS_ALLOWED_ORIGINS="http://localhost:5173,http://localhost:3000,https://nmcnpm.lethanhcong.site:46337,$CORS_ORIGINS"
            export COOKIE_SECURE=true
            export COOKIE_SAME_SITE=None
            export REDIRECT_AFTER_LOGIN_GOOGLE_FRONTEND=https://nmcnpm.lethanhcong.site:46337/google-loading
            export REDIRECT_AFTER_LOGIN_GOOGLE_FRONTEND_FAILURE=https://nmcnpm.lethanhcong.site:46337/failure
            export REDIRECT_URI=https://nmcnpm.lethanhcong.site:46337/google-loading

            echo "ðŸ”§ Environment variables for backendSocial:"
            echo "   CORS_ALLOWED_ORIGINS: $CORS_ALLOWED_ORIGINS"
            echo "   COOKIE_SECURE: $COOKIE_SECURE"
            echo "   REDIRECT_URI: $REDIRECT_URI"

            sudo docker-compose down || true
            sudo docker-compose up -d --build --force-recreate

            echo "â³ Waiting for services to be healthy..."
            sleep 15
            sudo docker-compose ps
            sudo docker-compose logs --tail=50 api-gateway

            echo "Deploying backendAI..."
            cd $WORKSPACE/src/backend/backendAI
            cat > .env << EOF
            DJANGO_SECRET_KEY=$SECRET_KEY
            DJANGO_DEBUG=$DEBUG
            DJANGO_ALLOWED_HOSTS=localhost,127.0.0.1,0.0.0.0,nmcnpm-api-ai.lethanhcong.site
            SUPABASE_DB_HOST=$SUPABASE_DB_HOST
            SUPABASE_DB_PORT=$SUPABASE_DB_PORT
            SUPABASE_DB_NAME=$SUPABASE_DB_NAME
            SUPABASE_DB_USER=$SUPABASE_DB_USER
            SUPABASE_DB_PASSWORD=$SUPABASE_DB_PASSWORD
            SUPABASE_DB_SSLMODE=$SUPABASE_DB_SSLMODE
            FREEPIK_API_KEY=$FREEPIK_API_KEY
            GEMINI_API_KEYS=$GEMINI_API_KEYS
            MONGO_URI=$MONGO_URI
            MONGO_DB_NAME=$MONGO_DB_NAME
            CORS_ORIGINS=$CORS_ORIGINS
            TIME_ZONE=$TIME_ZONE
            USE_TZ=$USE_TZ
            USE_GPU=$USE_GPU
            GPU_DEVICE_ID=$GPU_DEVICE_ID
            MODELSTUDIO_API_KEY=$MODELSTUDIO_API_KEY
            MODELSTUDIO_API_BASE=$MODELSTUDIO_API_BASE
            EOF
            sudo docker-compose down || true
            sudo docker-compose up -d --build --force-recreate

            echo "â³ Waiting for backendAI services to be healthy..."
            sleep 20

            echo "ðŸ“¥ Importing prompts data into MongoDB..."
            sudo docker exec backendai_api python import_prompts.py --file prompts.txt || echo "âš ï¸ Prompts import failed or already imported"

            sudo docker-compose ps
            sudo docker-compose logs --tail=30 backendAI

            cd $WORKSPACE/src/frontend
            rm -rf dist node_modules/.vite

            cat > .env << EOF
            VITE_GOOGLE_CLIENT_ID=$VITE_GOOGLE_CLIENT_ID
            VITE_GOOGLE_REDIRECT_URI=$VITE_GOOGLE_REDIRECT_URI
            VITE_API_GATEWAY=$VITE_API_GATEWAY
            VITE_AI_API_URL=$VITE_AI_API_URL
            VITE_SOCKET_URL=$VITE_SOCKET_URL
            VITE_SOCKET_COMMENT_URL=$VITE_SOCKET_COMMENT_URL
            VITE_COMMENT_API_URL=$VITE_COMMENT_API_URL
            VITE_FILE_UPLOAD_URL=$VITE_FILE_UPLOAD_URL
            VITE_SOCIAL_GATWAY_API_URL=$VITE_SOCIAL_GATWAY_API_URL
            VITE_TURN_CREDENTIAL_1=$VITE_TURN_CREDENTIAL_1
            VITE_TURN_CREDENTIAL_2=$VITE_TURN_CREDENTIAL_2
            VITE_TURN_URL_1=$VITE_TURN_URL_1
            VITE_TURN_URL_2=$VITE_TURN_URL_2
            VITE_TURN_USERNAME_1=$VITE_TURN_USERNAME_1
            VITE_TURN_USERNAME_2=$VITE_TURN_USERNAME_2
            VITE_FIREBASE_API_KEY=$VITE_FIREBASE_API_KEY
            VITE_FIREBASE_APP_ID=$VITE_FIREBASE_APP_ID
            VITE_FIREBASE_AUTH_DOMAIN=$VITE_FIREBASE_AUTH_DOMAIN
            VITE_FIREBASE_MEASUREMENT_ID=$VITE_FIREBASE_MEASUREMENT_ID
            VITE_FIREBASE_MESSAGING_SENDER_ID=$VITE_FIREBASE_MESSAGING_SENDER_ID
            VITE_FIREBASE_PROJECT_ID=$VITE_FIREBASE_PROJECT_ID
            VITE_FIREBASE_STORAGE_BUCKET=$VITE_FIREBASE_STORAGE_BUCKET
            VITE_PAYMENT_API_URL=$VITE_PAYMENT_API_URL
            VITE_PAYMENT_API_KEY=$VITE_PAYMENT_API_KEY
            VITE_CHATBOT_API_URL=$VITE_CHATBOT_API_URL
            VITE_CHATBOT_X_API_KEY=$VITE_CHATBOT_X_API_KEY
            VITE_CHATBOT_USER_ID=$VITE_CHATBOT_USER_ID
            VITE_CHATBOT_BEARER_TOKEN=$VITE_CHATBOT_BEARER_TOKEN
            EOF

            echo "=== Environment Variables ==="
            cat .env
            echo "======END======"

            npm install --prefer-offline --no-audit
            npm run build
            rm -rf $DEPLOY_PATH/*
            cp -r dist/* $DEPLOY_PATH
            sudo systemctl restart nginx
